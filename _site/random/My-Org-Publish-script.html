<!DOCTYPE html>
<html lang="en">
    <head>
  <meta charset="utf-8" />
  <meta http-equiv="x-ua-compatible" content="ie=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>My Org-Publish script</title>

  <link rel="stylesheet" href="/static/css/main.css">
  <link
    rel="canonical"
    href="http://localhost:4000/random/My-Org-Publish-script.html"
  />
  <link
    href="https://fonts.googleapis.com/css?family=Open+Sans:400,300,700,800,600"
    rel="stylesheet"
    type="text/css"
  />
  <link
    href="https://fonts.googleapis.com/css?family=Muli:400,300"
    rel="stylesheet"
    type="text/css"
  />
</head>
    <body>
        <div class ="main">
            <!-- top of page anchor-->
<a id="top"></a>

<header class ="header">
    <a href="/" class=logo-link><img width="70" class="logo" alt="Pixel Mishka" src="/static/logo/8bitlogo.png" /></a> 
  
    <nav>
        <ul class="nav">
            <li><a href=/Learning>Learning Notes</a></li>
            <li><a href=/Cheatsheets>Cheatsheets</a></li>
            <li><a href=/Random>Random</a></li>
        </ul>
    </nav>
</header>
    
            <article class="post">
    <header class="post-header">
        <h1 class="post-title"> My Org-Publish script </h1>
        <h4 class="post-date"> 29 Aug 2019 </h4>
    </header>
    <br>
    <main>
        <p>Majority of the notes that I take while learning online lessons is done on Emacs Org-Mode. I love Org-Mode due to its simplicity in design despite being an extremely powerful tool for notetaking and documenting. Within the world of Org-Mode, close to nothing is impossible. There is almost always a way.</p>

<p>When I first started using Emacs Org-Mode, there was definitely a learning curve that I had to overcome. However the time and effort that I put into learning this tool completely worth it. I foresee myself using Org-Mode for so much more than just learning notes for Programming-related online lessons.</p>

<p>In this post, what will be covered is the Org publish script that I use to batch export/ publish my .org files into .html pages.</p>

<p>Why script? So I can perform this action within the Terminal comfortably before incorporating it in a bash script.</p>

<p>Oh, about the bash script, actual full workflow that I set up involves a bash script that does a few other things that may be covered in another post. However the following content will be solely about the org-publish script.</p>

<p>There is also a setup file that I host on my github. This setup file is referenced on the preamble of all my Org files. It is used for htmlizing and CSS styling.</p>

<p>A few things to start off..</p>

<ul>
  <li>
    <p>emacs scripts have <code class="highlighter-rouge">.el</code> file extension. The language is Lisp code that defines Emacs configuration settings or add additional features to the program.</p>
  </li>
  <li>
    <p>I run the emacs script file in Terminal like this:</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>emacs <span class="nt">--batch</span> <span class="nt">-l</span> ~/.emacs.d/org-publish-Learning.el <span class="o">&gt;</span> ~/Documents/Org-HTMLs/logs/<span class="nv">$emacsLogFile</span> 2&gt;&amp;1 
</code></pre></div></div>

<p>The <code class="highlighter-rouge">--batch</code> flag indicates emacs to run in CLI mode (not GUI). The <code class="highlighter-rouge">l</code> is to load the lisp file, followed by the lisp file. What follows is optional. Its function is to save status logs in a log folder.</p>

<p>Let’s start with the actual lisp file:</p>

<p>First I initialize the script by loading packages and importing the necessary modules, including org modes, org export, publish and package.</p>

<div class="language-elisp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nv">package-initialize</span><span class="p">)</span>
<span class="p">(</span><span class="nb">require</span> <span class="ss">'org</span><span class="p">)</span>
<span class="p">(</span><span class="nb">require</span> <span class="ss">'ox</span><span class="p">)</span>
<span class="p">(</span><span class="nb">require</span> <span class="ss">'ox-publish</span><span class="p">)</span>
<span class="p">(</span><span class="nb">require</span> <span class="ss">'package</span><span class="p">)</span>
</code></pre></div></div>

<p>The following part defines some customized settings for Org-Mode.</p>

<div class="language-elisp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nv">custom-set-variables</span>
 <span class="o">'</span><span class="p">(</span><span class="nv">org-export-preserve-breaks</span> <span class="no">t</span><span class="p">)</span>
 <span class="o">'</span><span class="p">(</span><span class="nv">org-export-use-babel</span> <span class="no">nil</span><span class="p">)</span>
 <span class="o">'</span><span class="p">(</span><span class="nv">org-export-with-section-numbers</span> <span class="no">nil</span><span class="p">)</span>
 <span class="o">'</span><span class="p">(</span><span class="nv">org-export-with-sub-superscripts</span> <span class="no">nil</span><span class="p">)</span>
 <span class="o">'</span><span class="p">(</span><span class="nv">org-src-fontify-natively</span> <span class="no">t</span><span class="p">))</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- When export, keep the line breaks. On default, empty linebreaks are removed.
- When export, don't re-execute the source block. Instead, keep the result block generated and last saved.
- No number for headings
- No subscript and superscript when exporting. In Org-Mode syntax, superscripts and subscripts are precede by `^` and `_` respectively. 
- Code blocks to have Syntax highlighting. This is very important!
</code></pre></div></div>

<div class="language-elisp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">setq</span> <span class="nv">org-html-postamble</span> <span class="s">"&lt;p class=\"author\"&gt;Author: &lt;a href=\"https://akhsim.github.io/\"&gt;%a&lt;/a&gt; &lt;/p&gt;
                          &lt;p&gt;%c&lt;/p&gt;
                          &lt;p&gt;Created: %d&lt;/p&gt;
                          &lt;p class=\"date\"&gt;Updated: %C&lt;/p&gt;"</span><span class="p">)</span>

</code></pre></div></div>

<p>This is my secret ‘Back’ button that goes back to the homepage of my website. I don’t want to include this in my git hosted setup file for org mode as well as in the Emacs configuration because not all contents I publish into HTML need this.</p>

<div class="language-elisp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nv">defcustom</span> <span class="nv">org-hidden-links-additional-re</span> <span class="s">"\\(&lt;&lt;\\)[[:print:]]+\\(&gt;&gt;\\)"</span>
  <span class="s">"Regular expression that matches strings where the invisible-property of the sub-matches 1 and 2 is set to org-link."</span>
  <span class="ss">:type</span> <span class="o">'</span><span class="p">(</span><span class="nv">choice</span> <span class="p">(</span><span class="nv">const</span> <span class="ss">:tag</span> <span class="s">"Off"</span> <span class="no">nil</span><span class="p">)</span> <span class="nv">regexp</span><span class="p">)</span>
  <span class="ss">:group</span> <span class="ss">'org-link</span><span class="p">)</span>
<span class="p">(</span><span class="nv">make-variable-buffer-local</span> <span class="ss">'org-hidden-links-additional-re</span><span class="p">)</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">org-activate-hidden-links-additional</span> <span class="p">(</span><span class="nv">limit</span><span class="p">)</span>
  <span class="s">"Put invisible-property org-link on strings matching `org-hide-links-additional-re'."</span>
  <span class="p">(</span><span class="k">if</span> <span class="nv">org-hidden-links-additional-re</span>
      <span class="p">(</span><span class="nv">re-search-forward</span> <span class="nv">org-hidden-links-additional-re</span> <span class="nv">limit</span> <span class="no">t</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">goto-char</span> <span class="nv">limit</span><span class="p">)</span>
    <span class="no">nil</span><span class="p">))</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">org-hidden-links-hook-function</span> <span class="p">()</span>
  <span class="s">"Add rule for `org-activate-hidden-links-additional' to `org-font-lock-extra-keywords'
You can include this function in `org-font-lock-set-keywords-hook'."</span>
  <span class="p">(</span><span class="nv">add-to-list</span> <span class="ss">'org-font-lock-extra-keywords</span>
                              <span class="o">'</span><span class="p">(</span><span class="nv">org-activate-hidden-links-additional</span>
                                <span class="p">(</span><span class="mi">1</span> <span class="o">'</span><span class="p">(</span><span class="nv">face</span> <span class="nv">org-target</span> <span class="nv">invisible</span> <span class="nv">org-link</span><span class="p">))</span>
                <span class="p">(</span><span class="mi">2</span> <span class="o">'</span><span class="p">(</span><span class="nv">face</span> <span class="nv">org-target</span> <span class="nv">invisible</span> <span class="nv">org-link</span><span class="p">)))))</span>
<span class="p">(</span><span class="nv">add-hook</span> <span class="ss">'org-font-lock-set-keywords-hook</span> <span class="nf">#'</span><span class="nv">org-hidden-links-hook-function</span><span class="p">)</span>

</code></pre></div></div>

<p>This hides internal target <code class="highlighter-rouge">&lt;&lt;targer&gt;&gt;</code>. In Org-Mode, hide the emphasis markers. In exports, hide the whole target. These are basically internal anchors in my page.</p>

<div class="language-elisp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">defun</span> <span class="nv">replace-in-string</span> <span class="p">(</span><span class="nv">what</span> <span class="nv">with</span> <span class="nv">in</span><span class="p">)</span>				  
  <span class="p">(</span><span class="nv">replace-regexp-in-string</span> <span class="p">(</span><span class="nv">regexp-quote</span> <span class="nv">what</span><span class="p">)</span> <span class="nv">with</span> <span class="nv">in</span> <span class="no">nil</span> <span class="ss">'literal</span><span class="p">))</span> 
									  
<span class="p">(</span><span class="nb">defun</span> <span class="nv">org-html--format-image</span> <span class="p">(</span><span class="nv">source</span> <span class="nv">attributes</span> <span class="nv">info</span><span class="p">)</span>		  
  <span class="p">(</span><span class="k">progn</span>								  
    <span class="p">(</span><span class="k">setq</span> <span class="nv">source</span> <span class="p">(</span><span class="nv">replace-in-string</span> <span class="s">"%20"</span> <span class="s">" "</span> <span class="nv">source</span><span class="p">))</span>		  
    <span class="p">(</span><span class="nb">format</span> <span class="s">"&lt;img src=\"data:image/%s;base64,%s\"%s /&gt;"</span>		  
            <span class="p">(</span><span class="nb">or</span> <span class="p">(</span><span class="nv">file-name-extension</span> <span class="nv">source</span><span class="p">)</span> <span class="s">""</span><span class="p">)</span>			  
            <span class="p">(</span><span class="nv">base64-encode-string</span>					  
             <span class="p">(</span><span class="nv">with-temp-buffer</span>					  
               <span class="p">(</span><span class="nv">insert-file-contents-literally</span> <span class="nv">source</span><span class="p">)</span>		
              <span class="p">(</span><span class="nv">buffer-string</span><span class="p">)))</span>					 
            <span class="p">(</span><span class="nv">file-name-nondirectory</span> <span class="nv">source</span><span class="p">))</span>				  
    <span class="p">))</span>
</code></pre></div></div>

<p>What this does is embed any image I have on the Org files in the HTML file. There is probably millions of better ways including uploading an image folder into my <code class="highlighter-rouge">static</code> directory on my git.</p>

<div class="language-elisp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">setq</span> <span class="nv">org-publish-project-alist</span>
      <span class="o">'</span><span class="p">((</span><span class="s">"Learning"</span>
	 <span class="ss">:base-directory</span> <span class="s">"~/.staging/Org-HTMLs/Learning"</span>
	 <span class="ss">:base-extension</span> <span class="s">"org"</span>	
         <span class="ss">:publishing-directory</span> <span class="s">"~Documents/Org-HTMLs/Learning"</span>
	 <span class="ss">:recursive</span> <span class="no">t</span>
	 <span class="ss">:publishing-function</span> <span class="nv">org-html-publish-to-html</span><span class="p">)))</span>

<span class="p">(</span><span class="k">setq</span> <span class="nv">user-full-name</span> <span class="s">"Mishka Nguyen"</span><span class="p">)</span>
</code></pre></div></div>

<p>This is quite important. It sets  attributes for the <code class="highlighter-rouge">org-publish-project</code> function which will be called at the end of this script.</p>

<div class="language-elisp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nv">load-theme</span> <span class="ss">'monokai-pro</span> <span class="no">t</span><span class="p">)</span>
<span class="p">(</span><span class="nv">org-mode</span><span class="p">)</span>
<span class="p">(</span><span class="nv">org-publish-project</span> <span class="s">"Learning"</span> <span class="no">t</span><span class="p">)</span>
</code></pre></div></div>

<p>I like monokai, monokai pro and other variances. What I’m actually using is “molokai-pro” on my VSCode and Emacs. In this situation, the theme will only be loaded for the purpose of making my code blocks pretty. My stylesheet covers everything else.</p>

<p>Lastly, the <code class="highlighter-rouge">org-publish-project</code> function is called, to publish the “Learning” project with the attributes that have been set in the previous code blocks. The function call exports/ publishes all <code class="highlighter-rouge">.org</code> files in the base directory and put all HTML files into the Learning Folder. These HTML files are then published to git.</p>

    </main>
</article>
        <footer>
<p>Mishka's Page, 2019 —</p>
</footer>
        </div>
    </body>
</html>